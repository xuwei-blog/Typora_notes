# 江科大自化协C51

## 概述

[TOC]

## 常识

### 命名规则

![image-20230226221115941](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/image-20230226221115941.png)

## demo

### 独立按键

- 按键原理图

![image-20230317105323262](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303171053304.png)

- 按键的抖动

![image-20230317171629262](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303171716326.png)

- 程序

```C
#include <REGX52.H>
void Delay(unsigned int xms)		//@12.000MHz
{
	unsigned char i, j;
	while(xms--)
	{
		i = 12;
		j = 169;
		do
		{
			while (--j);
		} while (--i);
	}

}

void main()
{
	while(1)
	{
		if(P3_1 == 0)
		{
			Delay(20);	//消除抖动
			while(P3_1 == 0);
			Delay(20);
			P2_0 = ~P2_0;
		}
	}
}
```

### 数码管

- 区分共阴极和共阳极

![image-20230317180714189](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303171807245.png)

- 段码

数码管的数据位

- 原理图

![image-20230317183344110](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303171833155.png)

- 字符数组

> 数据的高位 对应 端口的高位，和大端存储没有关系
>
> 例如：
>
> ```
> //显示字符9
> abcdefg[dp] 对应为 1111 0110
> 端口最高位 - 最低位  0110 1111  ==》 6F
> ```

![image-20230321101532072](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303211015104.png)

#### 数码管程序

```C
unsigned char NixieTable[] = {0x3F,0x06,0x5B,0x4F,0x66,
							  0x6D,0x7D,0x07,0x7F,0x6F};

void Delay(unsigned int xms)		//@12.000MHz
{
	unsigned char i, j;
	while(xms--)
	{
		i = 2;
		j = 239;
		do
		{
			while (--j);
		} while (--i);
	}	
}

void Nixie(unsigned char Location,Number)
{
	switch(Location)
	{
		//38ÒëÂëÆ÷Ñ¡Ôñ
		case 1:P2_4 = 1;P2_3 = 1;P2_2 = 1;break;
		case 2:P2_4 = 1;P2_3 = 1;P2_2 = 0;break;
		case 3:P2_4 = 1;P2_3 = 0;P2_2 = 1;break;
		case 4:P2_4 = 1;P2_3 = 0;P2_2 = 0;break;
		case 5:P2_4 = 0;P2_3 = 1;P2_2 = 1;break;
		case 6:P2_4 = 0;P2_3 = 1;P2_2 = 0;break;
		case 7:P2_4 = 0;P2_3 = 0;P2_2 = 1;break;
		case 8:P2_4 = 0;P2_3 = 0;P2_2 = 0;break;		
	}
	P0 = NixieTable[Number];
    Delay(1);	//不延时会导致数码管很暗
    P0 = 0x00;	//清零
}
```

#### 数码管消影

> 显示流程：
>
> 位选 - 段选 -位选 - 段选 -位选 - 段选  .......
>
> 执行太快，会篡位
>
> 如何优化？
>
> 位选 - 段选 - 清零 - 位选 - 段选 - 清零 - 位选 - 段选 - 清零 .......

#### 数码管驱动方式

- 单片机直接扫描
  - 硬件设备简单，但会消耗大量的CPU时间
- 专用驱动芯片（例如TM1640）
  - 内部自带显存、扫描电路、单片机只需要告诉他显示什么就行

![image-20230321103229423](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303211032455.png)

### LCD1602

- 原理图

![image-20230321121951965](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303211219998.png)

- 模块化代码

![image-20230321122019956](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303211220016.png)

#### 忽略报错

![image-20230323121653385](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303231216450.png)

### 矩阵键盘

#### 扫描的概念

![image-20230321132150237](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303211321295.png)

- 原理图

![image-20230321211807119](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303212118155.png)

#### 矩阵键盘代码

```C
unsigned char MatrixKey()
{
	unsigned char KeyNumber = 0;
	//按列扫描，因为按行扫描会有接口冲突
	P1 = 0xFF;	//清零
	P1_3 = 0;	//选择第一列，再判断第几行有数据
	if(P1_7 == 0){Delay(20);while(P1_7 == 0);Delay(20);KeyNumber = 1;}
	if(P1_6 == 0){Delay(20);while(P1_6 == 0);Delay(20);KeyNumber = 5;}
	if(P1_5 == 0){Delay(20);while(P1_5 == 0);Delay(20);KeyNumber = 9;}
	if(P1_4 == 0){Delay(20);while(P1_4 == 0);Delay(20);KeyNumber = 13;}
	
	P1 = 0xFF;
	P1_2 = 0;	//选择第二列
	if(P1_7 == 0){Delay(20);while(P1_7 == 0);Delay(20);KeyNumber = 2;}
	if(P1_6 == 0){Delay(20);while(P1_6 == 0);Delay(20);KeyNumber = 6;}
	if(P1_5 == 0){Delay(20);while(P1_5 == 0);Delay(20);KeyNumber = 10;}
	if(P1_4 == 0){Delay(20);while(P1_4 == 0);Delay(20);KeyNumber = 14;}
	
	P1 = 0xFF;
	P1_1 = 0;
	if(P1_7 == 0){Delay(20);while(P1_7 == 0);Delay(20);KeyNumber = 3;}
	if(P1_6 == 0){Delay(20);while(P1_6 == 0);Delay(20);KeyNumber = 7;}
	if(P1_5 == 0){Delay(20);while(P1_5 == 0);Delay(20);KeyNumber = 11;}
	if(P1_4 == 0){Delay(20);while(P1_4 == 0);Delay(20);KeyNumber = 15;}
	
	P1 = 0xFF;
	P1_0 = 0;
	if(P1_7 == 0){Delay(20);while(P1_7 == 0);Delay(20);KeyNumber = 4;}
	if(P1_6 == 0){Delay(20);while(P1_6 == 0);Delay(20);KeyNumber = 8;}
	if(P1_5 == 0){Delay(20);while(P1_5 == 0);Delay(20);KeyNumber = 12;}
	if(P1_4 == 0){Delay(20);while(P1_4 == 0);Delay(20);KeyNumber = 16;}
	
	return KeyNumber;
}
```

#### 密码锁

```C
#include <REGX52.H>
#include "Delay.h"
#include "Nixie.h"
#include "LCD1602.h"
#include "MatrixKey.h"

unsigned char KeyNum;
unsigned int Password;
unsigned char Count;

void main()
{

	LCD_Init();
	LCD_ShowString(1,1,"password:");
 
	while(1)
	{
		KeyNum = MatrixKey();
		if(KeyNum != 0)
		{
			if(KeyNum <= 10)
			{
				if(Count < 4)
				{
					Password *= 10;				//将密码左移一位
					Password += KeyNum % 10;	//获取一位密码
					Count++;
				}
				LCD_ShowNum(2,1,Password,4);
			}
			if(KeyNum == 11) //S11按下
			{
				if(Password == 2345)
				{
					LCD_ShowString(1,10,"right");
					Password = 0;//清零
					Count = 0;
					LCD_ShowNum(2,1,Password,4);
				}
				else
				{
					LCD_ShowString(1,10,"err");
					Password = 0;//清零
					Count = 0;
					LCD_ShowNum(2,1,Password,4);
				}
			}
			if(KeyNum == 12)
			{
				Password = 0;//清零
				Count = 0;
				LCD_ShowNum(2,1,Password,4);
			}

		}
	}
}
```



### 定时器

> 简介：51单片机的定时器属于单片机的内部资源，其电路的链接和运转都在单片机内部完成
>
> 作用：
>
> 1. 用于计时系统，可以实现软件计时
> 2. 替代长时间的Delay，提高CPU运行效率和处理速度

> SYSclk：系统时钟，即晶振周期，51开发板晶振为12MHZ

#### 4中工作模式

> 最常用的模式1：16位计数器/定时器 T0、T1

#### 外接时钟

![image-20230322112016303](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303221120358.png)

#### 计数器

> 0~65535
>
> 每隔1us计数＋1
>
> 最长可定时 65535us

### 中断

#### 89C52的中断资源

> 中断源：
>
> - 外部中断0
> - 定时器0中断
> - 外部中断1
> - 定时器1中断
> - 串口中断
> - 外部中断2
> - 外部中断3

#### 中断号

![image-20230322113435794](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303221134847.png)



#### 中断初始化、中断服务程序

```C
void Timer0_Init()
{
	//TOMD 不可位寻址，只能整体赋值
	//TMOD = 0x01;	//0000 0001
	//改进TMOD赋值
	TMOD = TMOD & 0xF0;//TMOD高四位不变，低四位清零
	TMOD = TMOD | 0x01;//TMOD高四位不变，低四位置1
	
	//TCON 可位寻址，可按位赋值
	TF0 = 0;
	TR0 = 1;
	TH0 = 64535/256;
	TL0 = 64535%256+1;
	ET0 = 1;
	EA = 1;
	PT0 = 0;
}

/*定时器中断函数
void Timer0_Routine() interrupt 1
{
	static unsigned int T0Count;
	
	TH0 = 64535/256;	//保证下一次中断的初始值不变
	TL0 = 64535%256 + 1;//65536才会中断
	
	T0Count++;
	if(T0Count >= 1000)
	{
		T0Count = 0;
		
	}
}
*/
```

### 时钟demo

```C
unsigned char Sec,Min,Hour;

void main()
{
	LCD_Init();
	Timer0_Init();
	
	LCD_ShowString(1,1,"Clock");
	LCD_ShowString(2,1,"  :  :");
	
    while(1)
    {
        LCD_ShowNum(2,1,Hour,2);
		LCD_ShowNum(2,4,Min,2);
		LCD_ShowNum(2,7,Sec,2);
    }
}

void Timer0_Routine() interrupt 1
{
	static unsigned int T0Count;
	
	TH0 = 64535/256;	//保证下一次中断的初始值不变
	TL0 = 64535%256 + 1;//65536才会中断
	
	T0Count++;
	if(T0Count >= 1000)
	{
		T0Count = 0;
		Sec++;
		if(Sec >= 60)
		{
			Sec = 0;
			Min++;
			if(Min >= 60)
			{
				Min = 0;
				Hour++;
				if(Hour >= 24)
				{
					Hour = 0;
				}
			}
		}
	}
}
```

### 串口

#### 简介

![image-20230323131904780](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303231319045.png)

> 串口只能用计时器1

#### 串口硬件电路

![image-20230323132723581](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303231327697.png)

#### 电平标准

![image-20230323133010126](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303231330208.png)

#### 通讯接口

![image-20230323134000675](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303231340766.png)

#### 相关术语

![image-20230323185644384](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303231856482.png)

> SCL：时钟线

#### 51单片机的UART

![image-20230323224804657](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303232248727.png)

#### 串口参数

![image-20230323225526896](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303232255986.png)

#### 时序图

#### 串口寄存器

![image-20230323231106344](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303232311454.png)

#### 串口中断

![image-20230323231624836](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303232316945.png)

#### 串口寄存器

![image-20230323231651866](C:\Users\13192\AppData\Roaming\Typora\typora-user-images\image-20230323231651866.png)

#### 串口程序

```C
#include <REGX52.H>

void UART_Init()
{

	PCON |= 0x80;		//使能波特率倍速位SMOD
	SCON = 0x50;		//8位数据,可变波特率,接收使能
	TMOD &= 0x0F;		//清除定时器1模式位
	TMOD |= 0x20;		//设定定时器1为8位自动重装方式
	TL1 = 0xF3;		//设定定时初值			F3 = 243(D)
	TH1 = 0xF3;		//设定定时器重装值		   256 - 243 = 13us
	ET1 = 0;		//禁止定时器1中断			溢出率 1 / 13 = 0.07692MHz
	TR1 = 1;		//启动定时器1             0.0792MHz / 16 = 0.00480769MHz ≈ 4800Hz
	EA = 1;			//启动所有中断
	ES = 1;			//启动串口中断

}

void UART_SendByte(unsigned char Byte)
{
	SBUF = Byte;
	while(TI == 0);
	TI = 0;
}


/**
  * @brief 串口中断模板
  * @param
  * @retval
  */
void UART_Routine() interrupt 4
{
	if(RI == 1)		//确保是接收中断
	{

		RI = 0;
	}
}
```

### LED点阵屏

#### 显示原理

![image-20230324212803589](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303242139518.png)

#### 74HC595

- 原理图

![image-20230324223405065](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303242234116.png)

- 用于IO扩展

![image-20230324214135441](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303242141520.png)

- 一些细节

> 需要OE接低电平（OE 接 GND）



#### sfr、sbit

![image-20230324222940271](https://typora-notes-codervv.oss-cn-shanghai.aliyuncs.com/img_for_typora/202303242229380.png)

#### 595程序代码

```C
#include <REGX52.H>

sbit RCK = P3^5;//RCLK
sbit SCK = P3^6;//SRCLK
sbit SER = P3^7;//SER

void _74HC595_WriteByte(unsigned char Byte)
{
	unsigned char i;
	for(i = 0; i < 8; i++)
	{
		SER = Byte & (0x80 >> i); //非0即1,8位数据分别移位
		SCK = 1; 				  //SCLK高电平
		SER = 0;
	}
	RCK = 1;	//8位准备好，一起送出去
	RCK = 0;

}

void main()
{
	SCK = 0;
	RCK = 0;
	_74HC595_WriteByte(0x00);
    while(1)
    {
        
    }
}
```

